import logging
from typing import Tuple
import dash
from dash import html, dcc, Input, Output, dash_table
import dash_bootstrap_components as dbc
import pandas as pd
import plotly.express as px
import plotly.graph_objects as go
from pymongo import MongoClient
import base64
import os

logging.basicConfig(
    level=logging.INFO,
    format="%(asctime)s [%(levelname)s] %(message)s"
)
logger = logging.getLogger(__name__)

COLORS = {
    'primary': '#C51D34',
    'secondary': '#F5F5F5',
    'accent': '#8B1538',
    'light_red': '#E85A70',
    'dark_gray': '#2C3E50',
    'success': '#27AE60',
    'warning': '#F39C12',
    'info': '#3498DB',
    'white': '#FFFFFF'
}
def datoss() -> Tuple[pd.DataFrame, pd.DataFrame]:
    try:
        ruta = MongoClient("mongodb://localhost:27017/", serverSelectionTimeoutMS=5000)
        db = ruta["LasEstadisticasMundial"]
        losequipos = pd.DataFrame(list(db["goles_por_equipo"].find()))
        goleadores = pd.DataFrame(list(db["goleadores_mundiales"].find()))
        # Eliminar campo _id
        for df in (losequipos, goleadores):
            if "_id" in df.columns:
                df.drop(columns=["_id"], inplace=True)
            df["G"] = pd.to_numeric(df["G"], errors="coerce")
            df["A√±o"] = pd.to_numeric(df["A√±o"], errors="coerce")
        logger.info("Datos cargados desde MongoDB")
        return losequipos, goleadores
    except Exception as e:
        logger.error(f"Error conectando a MongoDB: {e}")
        losequipos = pd.DataFrame({
            'Equipo': ['Brasil','Alemania','Argentina','Espa√±a','Francia'],
            'A√±o': [2022]*5,
            'G': [8,7,6,5,4]
        })
        goleadores = pd.DataFrame({
            'Jugador': ['Messi','Mbapp√©','Giroud','√Ålvarez','Gakpo'],
            'Equipo': ['Argentina','Francia','Francia','Argentina','Pa√≠ses Bajos'],
            'A√±o': [2022]*5,
            'G': [7,8,4,4,3]
        })
        return losequipos, goleadores
losequipos, goleadores = datoss()

app = dash.Dash(
    __name__,
    external_stylesheets=[dbc.themes.BOOTSTRAP, "/assets/style.css"]
)
def create_metric_card(title: str, value: str, icon: str, color: str = COLORS['primary']):
    return dbc.Card([
        dbc.CardBody([
            html.Div([
                html.Div([html.I(className=f"fas fa-{icon} fa-2x", style={'color': color})],
                         className="metric-icon"),
                html.Div([
                    html.H3(value, className="metric-value"),
                    html.P(title, className="metric-title")
                ], className="metric-content")
            ], className="metric-card-inner")
        ])
    ], className="metric-card")

def elheader(title: str, subtitle: str = None):
    return html.Div([
        html.H2(title, className="section-main-title"),
        html.P(subtitle, className="section-subtitle") if subtitle else None,
        html.Div(className="section-divider")
    ], className="section-header")

# ‚Äî Layout Principal ‚Äî
app.layout = html.Div([

    html.Div(
        className="about-us-section",
        style={
            "backgroundColor": "#6D0C2E",
            "padding": "60px 0"
        },
        children=[
            html.H1(
                "EstadistiGOL",
                style={"color": "#FFFFFF", "textAlign": "center"}
            ),
            html.P(
                "Estad√≠sticas del mundial que marcaron en la historia",
                style={"color": "#FFFFFF", "textAlign": "center"}
            ),
        ]
    ),
    html.Div(className="hero-section", children=[
        html.Div(className="hero-overlay"),
        html.Div(className="hero-container", children=[
            html.Div(className="hero-content", children=[
                html.H1("ESTAD√çSTICAS  MUNDIAL", className="hero-title"),
                html.P("Analisis de los datos referentes a los mundiales pasados", className="hero-subtitle"),
                html.Div([
                    html.Span("üèÜ", className="hero-emoji"),
                    html.Span("‚öΩ", className="hero-emoji"),
                    html.Span("üìä", className="hero-emoji"),
                ], className="hero-emojis")
            ])
        ])
    ]),

    dbc.Container(fluid=True, className="description-section", children=[
        dbc.Row([
            dbc.Col([
                dbc.Card([
                    dbc.CardBody([
                        html.H3("üìä DASHBOARD INTERACTIVO DE ESTAD√çSTICAS FIFA WORLD CUP üèÜ",
                                className="description-title"),
                        html.Hr(className="description-divider"),
                        html.P([
                            "Este proyecto consta de ", html.Strong("2 dashboards"),
                            " de an√°lisis interactivo, desarrollado con ", html.Strong("Dash"),
                            ", ", html.Strong("Plotly"), " y ", html.Strong("MongoDB"),
                            ", que permite explorar de manera visual y din√°mica las estad√≠sticas hist√≥ricas m√°s relevantes de la Copa Mundial de la FIFA."
                        ], className="description-text"),

                        html.H4("üß† FUNCIONALIDADES DESTACADAS:", className="description-subtitle"),
                        html.Ul([
                            html.Li("An√°lisis por a√±o de las selecciones m√°s goleadoras en cada Mundial."),
                            html.Li(
                                "Visualizaci√≥n de los m√°ximos goleadores por torneo, con m√∫ltiples filtros y comparativas."),
                            html.Li(
                                "Gr√°ficos din√°micos: barras, l√≠neas, mapas de calor, treemaps, radar charts y m√°s."),
                            html.Li("Tablas detalladas para consulta de datos espec√≠ficos."),
                            html.Li("Secci√≥n de datos curiosos que resaltan momentos hist√≥ricos √∫nicos del torneo."),
                            html.Li("Dise√±o moderno, responsivo y visualmente atractivo.")
                        ], className="description-list"),

                        html.H4("üíæ FUENTE DE DATOS:", className="description-subtitle"),
                        html.P([
                            "Los datos son obtenidos desde una base de datos MongoDB con dos colecciones principales: ",
                            html.Code("goles_por_equipo"), " y ", html.Code("goleadores_mundiales"), "."
                        ], className="description-text"),

                        html.H4("üéØ OBJETIVO:", className="description-subtitle"),
                        html.P(
                            "Ofrecer una herramienta educativa, informativa y entretenida para todos los fan√°ticos del f√∫tbol.",
                            className="description-text")
                    ])
                ], className="description-card")
            ], md=12)
        ])
    ]),

dbc.Container(fluid=True, className="feature-section", children=[
    dbc.Row([
        dbc.Col(
            html.Img(
                src="C:/Users/mg_ma/PycharmProjects/pythonProject/templates/.venv/share/assets/messi_copa.jpg",
                style={"width": "100%", "borderRadius": "8px"}
            ),
            md=6
        ),
        dbc.Col(
            html.Div([
                html.H3("Visi√≥n general del Campeonato"),
                html.P(
                    "Los dashboards sintetizan datos hist√≥ricos de goles, equipos y estad√≠sticas clave, "
                    "facilitando la toma de decisiones y la comparaci√≥n de rendimientos."
                )
            ], style={"padding": "20px"}),
            md=6
        )
    ], align="center", style={"margin": "60px 0"}),
    dbc.Row([
        dbc.Col(
            html.Div([
                html.H3("Cobertura de Momentos Clave"),
                html.P(
                    "Con gr√°ficos interactivos puedes seguir cada jugada importante y entender "
                    "c√≥mo influyen en el resultado global del torneo."
                )
            ], style={"padding": "20px"}),
            md=6
        ),
        dbc.Col(
            html.Img(
                src="C:/Users/mg_ma/PycharmProjects/pythonProject/templates/.venv/share/assets/portada.jpg",
                style={"width": "100%", "borderRadius": "8px"}
            ),
            md=6
        )
    ], align="center", style={"margin": "60px 0"}),
]),


    # === M√âTRICAS GENERALES ===
    dbc.Container(fluid=True, className="metrics-section", children=[
        dbc.Row(className="metrics-row", children=[
            dbc.Col(create_metric_card("Mundiales Analizados", "21", "trophy"), md=3),
            dbc.Col(create_metric_card("Pa√≠ses Participantes", "200+", "flag", COLORS['info']), md=3),
            dbc.Col(create_metric_card("Goles Registrados", "2,500+", "futbol", COLORS['success']), md=3),
            dbc.Col(create_metric_card("Leyendas del F√∫tbol", "1,000+", "star", COLORS['warning']), md=3),
        ])
    ]),

    dbc.Container(fluid=True, className="analysis-section", children=[
        elheader(
            "üèÜ AN√ÅLISIS DE EQUIPOS GOLEADORES",
            "Descubre qu√© selecciones han dominado en cada Mundial"
        ),
        # Controles
        dbc.Row(className="controls-row", children=[
            dbc.Col(md=4, children=[
                html.Div(className="control-container", children=[
                    html.Label("üìÖ Selecciona el Mundial:", className="control-label"),
                    dcc.Dropdown(
                        id="anio-equipos",
                        options=[{"label": f"Mundial {a}", "value": a} for a in sorted(losequipos["A√±o"].unique())],
                        value=max(losequipos["A√±o"].unique()),
                        clearable=False, className="custom-dropdown"
                    )
                ])
            ]),
            dbc.Col(md=4, children=[
                html.Div(className="control-container", children=[
                    html.Label("üìä Tipo de Vista:", className="control-label"),
                    dcc.RadioItems(
                        id="vista-equipos",
                        options=[
                            {"label": "Top 10", "value": "top10"},
                            {"label": "Todos", "value": "todos"}
                        ],
                        value="top10", inline=True, className="custom-radio"
                    )
                ])
            ])
        ]),
        # 4 Gr√°ficas
        dbc.Row(className="dashboard-row", children=[
            dbc.Col(dbc.Card([dbc.CardHeader("Ranking de Goleadores"), dbc.CardBody(dcc.Graph(id="bar-equipos"))],
                            className="dashboard-card"), md=6),
            dbc.Col(dbc.Card([dbc.CardHeader("Distribuci√≥n de Goles"), dbc.CardBody(dcc.Graph(id="pie-equipos"))],
                            className="dashboard-card"), md=6),
        ]),
        dbc.Row(className="dashboard-row", children=[
            dbc.Col(dbc.Card([dbc.CardHeader("Evoluci√≥n Hist√≥rica"), dbc.CardBody(dcc.Graph(id="heatmap-equipos"))],
                            className="dashboard-card"), md=6),
            dbc.Col(dbc.Card([dbc.CardHeader("Tendencia Temporal"), dbc.CardBody(dcc.Graph(id="line-equipos"))],
                            className="dashboard-card"), md=6),
        ]),
        # Tabla
        dbc.Row(className="table-row", children=[
            dbc.Col(dbc.Card([
                dbc.CardHeader("Datos Detallados"),
                dbc.CardBody([
                    dash_table.DataTable(
                        id="tabla-equipos",
                        columns=[{"name": "Equipo", "id": "Equipo"},
                                 {"name": "A√±o", "id": "A√±o"},
                                 {"name": "Goles", "id": "G"}],
                        data=[], page_size=10,
                        style_table={"overflowX": "auto"},
                        style_header={"backgroundColor": COLORS['primary'], "color": "white", "textAlign": "center"},
                        style_cell={"padding": "12px", "textAlign": "center"},
                        style_data_conditional=[{'if': {'row_index': 'odd'}, 'backgroundColor': COLORS['secondary']}]
                    )
                ])
            ], className="table-card"), md=12)
        ])
    ]),

    html.Hr(className="section-separator"),

    dbc.Container(fluid=True, className="analysis-section", children=[
        elheader(
            "‚öΩ AN√ÅLISIS DE GOLEADORES HIST√ìRICOS",
            "Los m√°ximos artilleros que han marcado la historia del f√∫tbol"
        ),
        # Controles
        dbc.Row(className="controls-row", children=[
            dbc.Col(md=4, children=[
                html.Div(className="control-container", children=[
                    html.Label("üìÖ Selecciona el Mundial:", className="control-label"),
                    dcc.Dropdown(
                        id="anio-goleadores",
                        options=[{"label": f"Mundial {a}", "value": a} for a in sorted(goleadores["A√±o"].unique())],
                        value=max(goleadores["A√±o"].unique()),
                        clearable=False, className="custom-dropdown"
                    )
                ])
            ]),
            dbc.Col(md=8, children=[
                html.Div(className="control-container", children=[
                    html.Label("üéØ Filtro por Goles:", className="control-label"),
                    dcc.RangeSlider(
                        id="goles-range",
                        min=0, max=int(goleadores["G"].max()), step=1,
                        marks={i: str(i) for i in range(0, int(goleadores["G"].max())+1, 2)},
                        value=[0, int(goleadores["G"].max())],
                        className="custom-slider"
                    )
                ])
            ])
        ]),
        # 4 Gr√°ficas
        dbc.Row(className="dashboard-row", children=[
            dbc.Col(dbc.Card([dbc.CardHeader("Top Goleadores"), dbc.CardBody(dcc.Graph(id="bar-goleadores"))],
                            className="dashboard-card"), md=6),
            dbc.Col(dbc.Card([dbc.CardHeader("Goles por Pa√≠s"), dbc.CardBody(dcc.Graph(id="treemap-goleadores"))],
                            className="dashboard-card"), md=6),
        ]),
        dbc.Row(className="dashboard-row", children=[
            dbc.Col(dbc.Card([dbc.CardHeader("Comparativa Top 5"), dbc.CardBody(dcc.Graph(id="radar-goleadores"))],
                            className="dashboard-card"), md=6),
            dbc.Col(dbc.Card([dbc.CardHeader("Rendimiento Individual"), dbc.CardBody(dcc.Graph(id="scatter-goleadores"))],
                            className="dashboard-card"), md=6),
        ]),
        # Tabla
        dbc.Row(className="table-row", children=[
            dbc.Col(dbc.Card([
                dbc.CardHeader("Ranking Completo"),
                dbc.CardBody([
                    dash_table.DataTable(
                        id="tabla-goleadores",
                        columns=[{"name": "Jugador", "id": "Jugador"},
                                 {"name": "Equipo", "id": "Equipo"},
                                 {"name": "Goles", "id": "G"},
                                 {"name": "A√±o", "id": "A√±o"}],
                        data=[], page_size=12,
                        style_table={"overflowX": "auto"},
                        style_header={"backgroundColor": COLORS['primary'], "color": "white", "textAlign": "center"},
                        style_cell={"padding": "12px", "textAlign": "center"},
                        style_data_conditional=[{'if': {'row_index': 'odd'}, 'backgroundColor': COLORS['secondary']}]
                    )
                ])
            ], className="table-card"), md=12)
        ])
    ]),

    html.Hr(className="section-separator"),
dbc.Container(fluid=True, className="feature-section", children=[
    dbc.Row([
        dbc.Col(
            html.Img(
                src="C:/Users/mg_ma/PycharmProjects/pythonProject/templates/.venv/share/assets/portero_pateando_pelota.jpg",
                style={"width": "100%", "borderRadius": "8px"}
            ),
            md=6
        ),
        dbc.Col(
            html.Div([
                html.H3("An√°lisis de Rendimiento Individual"),
                html.P(
                    "El desglose por jugador permite identificar fortalezas y √°reas de mejora, "
                    "comparando estad√≠sticas de pases, tiros y atajadas."
                )
            ], style={"padding": "20px"}),
            md=6
        )
    ], align="center", style={"margin": "60px 0"}),
    dbc.Row([
        dbc.Col(
            html.Div([
                html.H3("Perspectiva Estrat√©gica"),
                html.P(
                    "Los dashboards convierten datos detallados en informaci√≥n accionable, permitiendo identificar r√°pidamente tendencias y oportunidades para optimizar el rendimiento."
                )
            ], style={"padding": "20px"}),
            md=6
        ),
        dbc.Col(
            html.Img(
                src="abrazo_brazil.gif",
                style={"width": "100%", "borderRadius": "8px"}
            ),
            md=6
        )
    ], align="center", style={"margin": "60px 0"})

]),
    dbc.Container(fluid=True, className="facts-section", children=[
        elheader(
            "üéØ DATOS CURIOSOS DEL MUNDIAL",
            "Los momentos m√°s incre√≠bles de la historia"
        ),
        dbc.Row(className="facts-row", children=[
            dbc.Col(dbc.Card(className="fact-card-modern", children=[
                dbc.CardBody(html.Div(className="fact-content", children=[
                    html.I(className="fas fa-rocket fa-3x", style={'color': COLORS['primary']}),
                    html.H4("Primer Gol Hist√≥rico", className="fact-title"),
                    html.P("Lucien Laurent (Francia) anot√≥ el primer gol en Uruguay 1930 vs M√©xico.", className="fact-text")
                ]))
            ]), md=4),
            dbc.Col(dbc.Card(className="fact-card-modern", children=[
                dbc.CardBody(html.Div(className="fact-content", children=[
                    html.I(className="fas fa-fire fa-3x", style={'color': COLORS['warning']}),
                    html.H4("Mayor Goleada", className="fact-title"),
                    html.P("Hungr√≠a 10‚Äì1 El Salvador (Espa√±a 1982) la mayor goleada registrada.", className="fact-text")
                ]))
            ]), md=4),
            dbc.Col(dbc.Card(className="fact-card-modern", children=[
                dbc.CardBody(html.Div(className="fact-content", children=[
                    html.I(className="fas fa-bolt fa-3x", style={'color': COLORS['info']}),
                    html.H4("Gol m√°s R√°pido", className="fact-title"),
                    html.P("Bryan Robson anot√≥ a los 27s contra Francia en Espa√±a 1982.", className="fact-text")
                ]))
            ]), md=4),
        ]),
        dbc.Row(className="facts-row", children=[
            dbc.Col(dbc.Card(className="fact-card-modern", children=[
                dbc.CardBody(html.Div(className="fact-content", children=[
                    html.I(className="fas fa-crown fa-3x", style={'color': COLORS['success']}),
                    html.H4("El Rey Pel√©", className="fact-title"),
                    html.P("Pel√© es el √∫nico tricampe√≥n: 1958, 1962 y 1970.", className="fact-text")
                ]))
            ]), md=6),
            dbc.Col(dbc.Card(className="fact-card-modern", children=[
                dbc.CardBody(html.Div(className="fact-content", children=[
                    html.I(className="fas fa-trophy fa-3x", style={'color': COLORS['primary']}),
                    html.H4("Campeones Hist√≥ricos", className="fact-title"),
                    html.P("Brasil (5), Alemania (4), Italia (4), Argentina (3), Uruguay (2)‚Ä¶", className="fact-text")
                ]))
            ]), md=6),
        ])
    ]),

    html.Footer(className="footer", children=[
        html.Div(className="footer-content", children=[
            html.P("Marla Macias Gonzalez 2025 ", className="footer-text")
        ])
    ])
])

@app.callback(
    [Output("bar-equipos", "figure"),
     Output("pie-equipos", "figure"),
     Output("heatmap-equipos", "figure"),
     Output("line-equipos", "figure"),
     Output("tabla-equipos", "data")],
    [Input("anio-equipos", "value"), Input("vista-equipos", "value")]
)
def actualizar_equipos(a√±o: int, vista: str):
    df_a√±o = losequipos[losequipos["A√±o"] == a√±o].sort_values("G", ascending=False)
    df_mostrar = df_a√±o.head(10) if vista == "top10" else df_a√±o

    fig_bar = px.bar(df_mostrar, x="Equipo", y="G", title=f"Goles por Equipo - Mundial {a√±o}",
                     color_continuous_scale=[COLORS['light_red'], COLORS['primary']], text="G")
    fig_bar.update_layout(plot_bgcolor='rgba(0,0,0,0)', paper_bgcolor='rgba(0,0,0,0)',
                          font_color=COLORS['dark_gray'])
    fig_bar.update_traces(textposition='outside')

    fig_pie = px.pie(df_mostrar.head(8), names="Equipo", values="G", title="Distribuci√≥n de Goles")
    fig_pie.update_layout(plot_bgcolor='rgba(0,0,0,0)', paper_bgcolor='rgba(0,0,0,0)',
                          font_color=COLORS['dark_gray'])

    pivot = losequipos.pivot_table(index="Equipo", columns="A√±o", values="G", aggfunc="sum", fill_value=0)
    fig_heat = px.imshow(pivot, title="Evoluci√≥n Hist√≥rica de Goles")
    fig_heat.update_layout(plot_bgcolor='rgba(0,0,0,0)', paper_bgcolor='rgba(0,0,0,0)',
                           font_color=COLORS['dark_gray'])

    df_temp = losequipos.groupby("A√±o")["G"].sum().reset_index()
    fig_line = px.line(df_temp, x="A√±o", y="G", title="Tendencia Total de Goles", markers=True)
    fig_line.update_traces(line_color=COLORS['primary'], marker_color=COLORS['primary'])
    fig_line.update_layout(plot_bgcolor='rgba(0,0,0,0)', paper_bgcolor='rgba(0,0,0,0)',
                            font_color=COLORS['dark_gray'])

    return fig_bar, fig_pie, fig_heat, fig_line, df_mostrar.to_dict("records")

@app.callback(
    [Output("bar-goleadores","figure"),
     Output("treemap-goleadores","figure"),
     Output("radar-goleadores","figure"),
     Output("scatter-goleadores","figure"),
     Output("tabla-goleadores","data")],
    [Input("anio-goleadores","value"), Input("goles-range","value")]
)
def actualizar_goleadores(a√±o: int, rng: list):
    df_a√±o = goleadores[(goleadores["A√±o"]==a√±o)&
                           (goleadores["G"]>=rng[0])&(goleadores["G"]<=rng[1])].sort_values("G", ascending=False)

    fig1 = px.bar(df_a√±o.head(10), x="Jugador", y="G", color="Equipo",
                  title=f"Top Goleadores - Mundial {a√±o}", text="G")
    fig1.update_layout(plot_bgcolor='rgba(0,0,0,0)', paper_bgcolor='rgba(0,0,0,0)',
                       font_color=COLORS['dark_gray'])
    fig1.update_traces(textposition='outside')

    df_eq_sum = df_a√±o.groupby("Equipo")["G"].sum().reset_index()
    fig2 = px.treemap(df_eq_sum, path=["Equipo"], values="G",
                      title="Goles por Pa√≠s")
    fig2.update_layout(plot_bgcolor='rgba(0,0,0,0)', paper_bgcolor='rgba(0,0,0,0)',
                       font_color=COLORS['dark_gray'])

    top5 = df_a√±o.head(5)
    fig3 = go.Figure()
    for _, row in top5.iterrows():
        fig3.add_trace(go.Scatterpolar(
            r=[row["G"]]*5,
            theta=["Goles","Goles","Goles","Goles","Goles"],
            fill='toself', name=row["Jugador"]
        ))
    fig3.update_layout(polar=dict(radialaxis=dict(visible=True, range=[0, max(df_a√±o["G"])])),
                       title="Comparativa Top 5")

    fig4 = px.scatter(df_a√±o, x="G", y="Jugador", size="G", color="Equipo",
                      title="Rendimiento Individual")
    fig4.update_layout(plot_bgcolor='rgba(0,0,0,0)', paper_bgcolor='rgba(0,0,0,0)',
                       font_color=COLORS['dark_gray'])

    return fig1, fig2, fig3, fig4, df_a√±o.head(15).to_dict("records")
if __name__ == "__main__":
    app.run(debug=True)
